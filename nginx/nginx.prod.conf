events {
    # Le processus NGINX peut gérer jusqu’à 1024 connexions simultanées.
    worker_connections 1024;
}

http {

    # Inclusion des types MIME essentiels pour correctement servir les fichiers.
    include       /etc/nginx/mime.types;

    # Déclaration des types MIME pour les fichiers statiques.
    # Cela permet à NGINX d'envoyer le bon Content-Type HTTP selon l'extension du fichier.
    # Important pour que les navigateurs interprètent correctement les polices, images, etc.
    types {
        font/woff2 woff2;
        font/woff woff;
        application/vnd.ms-fontobject eot;
        font/ttf ttf;
        font/otf otf;
    }

    # Type MIME par défaut si non reconnu.
    default_type  application/octet-stream;

    # Activation de la compression gzip pour améliorer la performance réseau.
    gzip on;
    gzip_vary on;                       # Permet de gérer la réponse gzip en fonction de l'en-tête Accept-Encoding.
    gzip_min_length 1024;               # Active gzip uniquement pour les réponses > 1Ko.
    
    # Types MIME pour lesquels la compression gzip est activée.
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Bloc upstream backend:
    # Définit un alias "backend" pointant vers le container backend sur le port 3001.
    upstream backend {
        server backend:3001;
    }

    server {

        # ecoute sur le port 443 avec SSL
        listen 443 ssl;
        # ecoute sur le port 443 pour IPV6 -> devient le server par defaut
        listen [::]:443 ssl default_server; 

        # utilise uniquement TLSv1.2 ou TLSv1.3 pour connexions securisees
        ssl_protocols TLSv1.2 TLSv1.3;
        # chemin du certificat SSL
        ssl_certificate /etc/nginx/ssl/transcendence.crt ;
        # chemin vers la cle privee SSL
        ssl_certificate_key /etc/nginx/ssl/transcendence.key;

        server_name localhost;

        # Fichier index à servir par défaut dans le dossier racine.
        index index.html;

        # Fichiers de logs pour debug (accès et erreurs).
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log debug;

        # Route API:
        # Toutes les requêtes commençant par /api sont proxyées vers le backend Fastify.
        location /api {
            proxy_pass http://backend;
            proxy_http_version 1.1;       # Version HTTP nécessaire pour certaines fonctionnalités avancées comme WebSocket (ici moins critique en prod).
            
            # Transmission des en-têtes d’origine pour conserver l’info client dans le backend.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeout pour la connexion proxy (utile pour éviter les blocages).
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            # Sockets côté backend
            proxy_buffering off;
        }

        # Route pour servir les assets statiques (JS, CSS, images, polices, etc.)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            root /usr/share/nginx/html;     # Racine où sont copiés les fichiers build frontend.
            
            # Cache long (1 an) car ces fichiers sont versionnés (hash dans le nom).
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
            
            # Pas de logs d’accès pour ces fichiers statiques (pour alléger les logs).
            access_log off;
        }

        # Route principale pour le frontend (SPA - Single Page Application).
        location / {
            root /usr/share/nginx/html;     # Racine des fichiers frontend statiques.

            # History API fallback : si la route n'existe pas en fichier, on sert index.html.
            try_files $uri $uri/ /index.html;

            # Cache-control léger sur HTML
            add_header Cache-Control "no-cache, must-revalidate";
        }

        # Route de test simple pour vérifier que nginx fonctionne bien.
        location /nginx-status {
            return 200 "nginx is working";
            add_header Content-Type text/plain;
        }
    }
}
